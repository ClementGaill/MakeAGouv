<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MakeAGouv ‚Äì Cr√©e ton gouvernement id√©al</title>
    <meta name="description"
        content="Compose ton gouvernement fran√ßais id√©al ou absurde. Assigne des ministres r√©els ou fictifs et t√©l√©charge ta pyramide politique personnalis√©e.">
    <meta name="keywords"
        content="gouvernement fran√ßais, cr√©ation gouvernement, ministres, politique, personnalisation, makeagouv, simulateur gouvernement">
    <meta name="author" content="clementt.exe">

    <!-- Canonical -->
    <link rel="canonical" href="https://clementgaill.github.io/MakeAGouv/" />

    <!-- Open Graph (Facebook, LinkedIn, etc.) -->
    <meta property="og:title" content="MakeAGouv ‚Äì Cr√©e ton gouvernement id√©al üá´üá∑">
    <meta property="og:description"
        content="Compose ton gouvernement id√©al ou absurde et partage ton image personnalis√©e.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://makeagouv.fr/">
    <meta property="og:image" content="https://makeagouv.fr/Twitter%20post%20-%201.png">
    <meta property="og:locale" content="fr_FR">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MakeAGouv ‚Äì Cr√©e ton gouvernement id√©al üá´üá∑">
    <meta name="twitter:description"
        content="Compose ton gouvernement id√©al et t√©l√©charge ta pyramide politique personnalis√©e.">
    <meta name="twitter:image" content="https://makeagouv.fr/Twitter%20post%20-%201.png">
    <meta name="twitter:creator" content="@clementt_exe">

    <!-- Favicon -->
    <link rel="icon" href="https://makeagouv.fr/icon.ico" type="image/x-icon">

    <!-- Sitemap hint -->
    <link rel="sitemap" type="application/xml" title="Sitemap" href="https://https://makeagouv.fr/sitemap.xml" />

    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="export.css">

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-NCWTGVRF');</script>
    <!-- End Google Tag Manager -->
</head>

<body>
    <div class="container">
        <header>
            <h1>üá´üá∑ Cr√©ateur de Gouvernement</h1>
            <p class="subtitle">Composez votre gouvernement id√©al (ou absurde)</p>
        </header>

        <div class="pyramid" id="pyramid">
            <div id="ministries-container"></div>
        </div>

        <div class="actions">
            <button class="btn" onclick="addCustomMinistry()">
                <span>‚ûï</span> Ajouter un Minist√®re
            </button>
            <button class="btn download-img" onclick="downloadImage()">
                <span>‚¨áÔ∏è</span> T√©l√©charger PNG
            </button>
            <button class="btn" onclick="shareTwitter()">
                <span>üê¶</span> Partager
            </button>
        </div>

        <br>
        <div class="credits">
            <p><a href="https://x.com/clementt_exe" class="author">¬© clementt_exe</a></p>
            <p>/</p>
            <p><a href="https://paypal.me/clementtExe" class="author">Paypal</a></p>
        </div>
    </div>

    <!-- Modal de s√©lection -->
    <div class="modal" id="selectionModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">√ó</button>
            <div class="modal-header">Assigner un ministre</div>

            <div class="search-box">
                <input type="text" class="search-input" id="searchInput"
                    placeholder="Rechercher sur Wikipedia (ex: Mickey Mouse, Emmanuel Macron...)">
                <button class="btn btn-modal" onclick="searchWikipedia()">üîç</button>
            </div>

            <div id="searchResults" class="search-results"></div>

            <div class="custom-form">
                <div class="form-group">
                    <label class="form-label">Ou cr√©er une personnalit√© personnalis√©e</label>
                    <input type="text" class="form-input" id="customName" placeholder="Nom de la personnalit√©">
                </div>
                <div class="form-group">
                    <label class="form-label">Image (stock√©e localement)</label>
                    <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
                        <p>üìÅ Cliquez pour s√©lectionner une image</p>
                        <img id="previewImg" class="preview-img" style="display: none;">
                    </div>
                </div>
                <br>
                <button class="btn btn-modal" style="width: 100%; justify-content: center;"
                    onclick="assignCustomMinister()">
                    ‚úÖ Assigner cette personnalit√©
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        let ministries = [
            { id: 'pm', name: 'Premier Ministre', minister: null, fixed: true },
            { id: 'interior', name: 'Int√©rieur', minister: null },
            { id: 'economy', name: '√âconomie', minister: null },
            { id: 'defense', name: 'D√©fense', minister: null },
            { id: 'justice', name: 'Justice', minister: null },
            { id: 'foreign', name: 'Affaires √âtrang√®res', minister: null },
            { id: 'education', name: '√âducation Nationale', minister: null },
            { id: 'health', name: 'Sant√©', minister: null },
        ];

        let selectedMinistryId = null;
        let customImageData = null;
        let draggedElement = null;

        function renderMinistries() {
            const container = document.getElementById('ministries-container');
            container.innerHTML = '';

            // Premier Ministre en premier
            const pmRow = document.createElement('div');
            pmRow.className = 'ministry-row';
            const pm = ministries.find(m => m.id === 'pm');
            pmRow.appendChild(createMinistryCard(pm));
            container.appendChild(pmRow);

            // Autres minist√®res en grille
            const othersRow = document.createElement('div');
            othersRow.className = 'ministry-row';
            ministries.filter(m => m.id !== 'pm').forEach(ministry => {
                othersRow.appendChild(createMinistryCard(ministry));
            });
            container.appendChild(othersRow);
        }

        function createMinistryCard(ministry) {
            const card = document.createElement('div');
            card.className = `ministry-card ${ministry.id === 'pm' ? 'prime-minister' : ''}`;
            card.draggable = !ministry.fixed;
            card.dataset.ministryId = ministry.id;

            // Drag and drop events
            if (!ministry.fixed) {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            }
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragleave', handleDragLeave);

            const avatarContainer = document.createElement('div');
            avatarContainer.className = 'avatar-container';
            avatarContainer.onclick = (e) => {
                e.stopPropagation();
                openModal(ministry.id);
            };

            if (ministry.minister && ministry.minister.image) {
                const img = document.createElement('img');
                img.src = ministry.minister.image;
                img.alt = ministry.minister.name;
                avatarContainer.appendChild(img);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'avatar-placeholder';
                placeholder.textContent = 'üë§';
                avatarContainer.appendChild(placeholder);
            }

            const ministryName = document.createElement('div');
            ministryName.className = 'ministry-name';
            ministryName.contentEditable = !ministry.fixed;
            ministryName.textContent = ministry.name;
            ministryName.onclick = (e) => {
                e.stopPropagation();
            };
            ministryName.onblur = function () {
                const newName = this.textContent.trim();
                if (newName) {
                    ministry.name = newName;
                }
                this.classList.remove('editing');
            };
            ministryName.onfocus = function () {
                this.classList.add('editing');
            };
            ministryName.onkeydown = function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                }
            };

            const ministerName = document.createElement('div');
            ministerName.className = 'minister-name';
            ministerName.textContent = ministry.minister ? ministry.minister.name : '√Ä assigner';

            card.appendChild(avatarContainer);
            card.appendChild(ministryName);
            card.appendChild(ministerName);

            if (!ministry.fixed) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '√ó';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeMinistry(ministry.id);
                };
                card.appendChild(removeBtn);
            }

            return card;
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.ministry-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            if (this !== draggedElement && !this.classList.contains('prime-minister')) {
                this.classList.add('drag-over');
            }
            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this && !this.classList.contains('prime-minister')) {
                const draggedId = draggedElement.dataset.ministryId;
                const targetId = this.dataset.ministryId;

                const draggedIndex = ministries.findIndex(m => m.id === draggedId);
                const targetIndex = ministries.findIndex(m => m.id === targetId);

                if (draggedIndex !== -1 && targetIndex !== -1) {
                    const [removed] = ministries.splice(draggedIndex, 1);
                    ministries.splice(targetIndex, 0, removed);
                    renderMinistries();
                }
            }

            this.classList.remove('drag-over');
            return false;
        }

        function openModal(ministryId) {
            selectedMinistryId = ministryId;
            document.getElementById('selectionModal').classList.add('active');
            document.getElementById('searchInput').value = '';
            document.getElementById('customName').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('previewImg').style.display = 'none';
            customImageData = null;
        }

        function closeModal() {
            document.getElementById('selectionModal').classList.remove('active');
            selectedMinistryId = null;
        }

        async function searchWikipedia() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="loading">üîç Recherche en cours...</div>';

            try {
                const searchResponse = await fetch(
                    `https://fr.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=5`
                );
                const searchData = await searchResponse.json();

                if (searchData.query.search.length === 0) {
                    resultsContainer.innerHTML = '<div class="empty-state">Aucun r√©sultat trouv√© sur Wikipedia</div>';
                    return;
                }

                const results = await Promise.all(
                    searchData.query.search.map(async (item) => {
                        const imageResponse = await fetch(
                            `https://fr.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(item.title)}&prop=pageimages&format=json&pithumbsize=300&origin=*`
                        );
                        const imageData = await imageResponse.json();
                        const pages = imageData.query.pages;
                        const pageId = Object.keys(pages)[0];
                        const thumbnail = pages[pageId].thumbnail?.source || null;

                        return {
                            title: item.title,
                            image: thumbnail,
                        };
                    })
                );

                resultsContainer.innerHTML = '';
                results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    resultItem.onclick = () => assignMinister(result);

                    if (result.image) {
                        const img = document.createElement('img');
                        img.src = result.image;
                        img.className = 'result-img';
                        resultItem.appendChild(img);
                    } else {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'result-img';
                        placeholder.style.display = 'flex';
                        placeholder.style.alignItems = 'center';
                        placeholder.style.justifyContent = 'center';
                        placeholder.textContent = 'üë§';
                        resultItem.appendChild(placeholder);
                    }

                    const name = document.createElement('div');
                    name.className = 'result-name';
                    name.textContent = result.title;
                    resultItem.appendChild(name);

                    resultsContainer.appendChild(resultItem);
                });
            } catch (error) {
                console.error('Error:', error);
                resultsContainer.innerHTML = '<div class="empty-state">Erreur lors de la recherche</div>';
            }
        }

        function assignMinister(minister) {
            const ministry = ministries.find(m => m.id === selectedMinistryId);
            if (ministry) {
                // Assure-toi que 'name' existe
                ministry.minister = {
                    name: minister.name || minister.title || 'Inconnu',
                    image: minister.image || null
                };
                renderMinistries();
                closeModal();
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    customImageData = e.target.result;
                    const preview = document.getElementById('previewImg');
                    preview.src = customImageData;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function assignCustomMinister() {
            const name = document.getElementById('customName').value.trim();
            if (!name) {
                alert('Veuillez entrer un nom');
                return;
            }

            const minister = {
                title: name,
                name: name,
                image: customImageData || null
            };

            assignMinister(minister);
        }

        function addCustomMinistry() {
            const newMinistry = {
                id: `custom-${Date.now()}`,
                name: 'Nouveau Minist√®re',
                minister: null,
                fixed: false
            };
            ministries.push(newMinistry);
            renderMinistries();
        }

        function removeMinistry(id) {
            ministries = ministries.filter(m => m.id !== id);
            renderMinistries();
        }

        async function downloadImage() {
            try {
                // === Cr√©ation du loader visuel ===
                const loader = document.createElement('div');
                loader.className = 'loader-overlay';
                loader.innerHTML = `
            <div class="loader-spinner"></div>
            <p class="loader-text">G√©n√©ration de l'image...</p>
        `;
                document.body.appendChild(loader);

                // Laisse le loader appara√Ætre
                await new Promise(r => setTimeout(r, 50));

                // === Param√®tres export ===
                const EXPORT_W = 1200;
                const EXPORT_H = 675;
                const PADDING = 30;
                const GAP = 18;
                const MIN_COLS = 4;
                const MIN_CARD_MIN_WIDTH = 140;

                const exportContainer = document.createElement('div');
                exportContainer.className = 'export-container';
                exportContainer.style.width = EXPORT_W + 'px';
                exportContainer.style.height = EXPORT_H + 'px';
                exportContainer.style.padding = PADDING + 'px';
                exportContainer.style.boxSizing = 'border-box';
                exportContainer.style.overflow = 'hidden';
                exportContainer.style.position = 'relative';

                const inner = document.createElement('div');
                inner.className = 'export-inner';
                inner.style.width = (EXPORT_W - 2 * PADDING) + 'px';
                inner.style.display = 'flex';
                inner.style.flexDirection = 'column';
                inner.style.alignItems = 'center';

                // --- Titre ---
                const title = document.createElement('div');
                title.className = 'export-title';
                title.textContent = 'Mon Gouvernement';
                inner.appendChild(title);

                const subtitle = document.createElement('div');
                subtitle.className = 'export-subtitle';
                subtitle.textContent = 'Toi aussi cr√©e le tien sur makeagouv.fr';
                inner.appendChild(subtitle);

                // --- Premier Ministre ---
                const pm = ministries.find(m => m.id === 'pm');
                if (pm) {
                    const pmWrapper = document.createElement('div');
                    pmWrapper.style.display = 'flex';
                    pmWrapper.style.justifyContent = 'center';
                    pmWrapper.style.marginBottom = '18px';

                    const pmCard = document.createElement('div');
                    pmCard.className = 'export-card';
                    pmCard.style.width = '260px';
                    pmCard.style.padding = '14px';

                    const pmImg = document.createElement('img');
                    pmImg.src = pm.minister?.image || 'https://via.placeholder.com/120x120?text=üë§';
                    pmImg.alt = pm.minister?.name || pm.name;

                    const pmMinister = document.createElement('div');
                    pmMinister.className = 'minister';
                    pmMinister.textContent = pm.minister?.name || '√Ä assigner';

                    const pmMinistry = document.createElement('div');
                    pmMinistry.className = 'ministry';
                    pmMinistry.textContent = pm.name;

                    pmCard.appendChild(pmImg);
                    pmCard.appendChild(pmMinister);
                    pmCard.appendChild(pmMinistry);
                    pmWrapper.appendChild(pmCard);
                    inner.appendChild(pmWrapper);
                }

                // --- Autres minist√®res ---
                const otherMinistries = ministries.filter(m => m.id !== 'pm');
                const N = otherMinistries.length;

                const grid = document.createElement('div');
                grid.className = 'export-grid';
                grid.style.width = '100%';
                grid.style.boxSizing = 'border-box';
                const cardElements = [];

                otherMinistries.forEach(m => {
                    const card = document.createElement('div');
                    card.className = 'export-card';

                    const img = document.createElement('img');
                    img.src = m.minister?.image || 'https://via.placeholder.com/120x120?text=üë§';
                    img.alt = m.minister?.name || m.name;

                    const ministerName = document.createElement('div');
                    ministerName.className = 'minister';
                    ministerName.textContent = m.minister?.name || '√Ä assigner';

                    const ministryName = document.createElement('div');
                    ministryName.className = 'ministry';
                    ministryName.textContent = m.name;

                    card.appendChild(img);
                    card.appendChild(ministerName);
                    card.appendChild(ministryName);
                    grid.appendChild(card);
                    cardElements.push(card);
                });

                inner.appendChild(grid);
                exportContainer.appendChild(inner);

                // === Watermark discret ===
                const watermark = document.createElement('div');
                watermark.textContent = 'makeagouv.fr';
                watermark.className = 'export-watermark';
                exportContainer.appendChild(watermark);

                document.body.appendChild(exportContainer);

                // --- Attente chargement des images ---
                const images = exportContainer.querySelectorAll('img');
                await Promise.all(Array.from(images).map(img => {
                    return new Promise(resolve => {
                        if (img.complete && img.naturalWidth !== 0) resolve();
                        else {
                            img.onload = () => resolve();
                            img.onerror = () => resolve();
                        }
                    });
                }));

                await new Promise(requestAnimationFrame);
                await new Promise(requestAnimationFrame);

                // --- Ajustement automatique ---
                const innerAvailableW = EXPORT_W - 2 * PADDING;
                const innerAvailableH = EXPORT_H - 2 * PADDING;

                const maxColsByWidth = Math.max(1, Math.floor((innerAvailableW + GAP) / (MIN_CARD_MIN_WIDTH + GAP)));
                const desiredCols = Math.min(maxColsByWidth, Math.max(MIN_COLS, Math.min(N || MIN_COLS, maxColsByWidth)));

                const cols = desiredCols;
                const cardWidth = Math.floor((innerAvailableW - (cols - 1) * GAP) / cols);

                cardElements.forEach(card => {
                    card.style.width = cardWidth + 'px';
                    const img = card.querySelector('img');
                    if (img) {
                        const imgSize = Math.max(60, Math.min(120, Math.floor(cardWidth * 0.45)));
                        img.style.width = imgSize + 'px';
                        img.style.height = imgSize + 'px';
                        img.style.objectFit = 'cover';
                    }
                });

                grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                grid.style.gap = GAP + 'px';

                await new Promise(requestAnimationFrame);
                await new Promise(requestAnimationFrame);

                const contentH = inner.scrollHeight;
                const scale = Math.min(1, innerAvailableH / contentH);

                if (scale < 1) {
                    inner.style.transformOrigin = 'top center';
                    inner.style.transform = `scale(${scale})`;
                    inner.style.marginTop = Math.floor((innerAvailableH - contentH * scale) / 2) + 'px';
                }

                await new Promise(requestAnimationFrame);

                // --- Capture ---
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true
                });

                const link = document.createElement('a');
                link.download = 'mon-gouvernement.png';
                link.href = canvas.toDataURL();
                link.click();

                // --- Nettoyage ---
                document.body.removeChild(exportContainer);
                document.body.removeChild(loader);

            } catch (error) {
                console.error('Erreur :', error);
                alert('Erreur lors de la g√©n√©ration de l\'image');
            }
        }



        function shareTwitter() {
            const text = "J'ai cr√©√© mon gouvernement id√©al ! Cr√©e le tien sur #MakeAGouv !";
            const url = window.location.href;
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
            window.open(twitterUrl, '_blank');
        }

        // Initialisation
        renderMinistries();

        // Recherche avec Enter
        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                searchWikipedia();
            }
        });

        // Fermer le modal en cliquant √† l'ext√©rieur
        document.getElementById('selectionModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCWTGVRF" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
</body>

</html>